<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload video</title>
    <link rel="stylesheet" href="static/css/main.css">
    <link rel="stylesheet" href="static/css/header.css">
    <link rel="stylesheet" href="static/css/throws_page.css">
</head>
<body>
    <div class="header">
        <div class="left-buttons">
            <button id="home-button">Home Page</button>
            <button id="about-button">About</button>
            <button id="developers-button">Developers</button>
            <button id="blog-button">Blog</button>
        </div>
        <div class="right-buttons">
            <div class="username-frame" id="username-frame">
                <span id="username-display"></span>
            </div>
            <button id="login-button">Log In</button>
            <button id="register-button">Register</button>
            <button id="logout-button" style="display: none;">Log Out</button>
        </div>
    </div>
    <input type="file" id="file-input" accept="video/mp4" style="display: none;">
    <div class="throws-text">
        3-Point Throws
    </div>
    <div class="upload-container">
        <div class="buttons-container">
            <button type="button" onclick="triggerFileInput()">Upload Video</button>
            <button onclick="getStatistics()">Get statistics</button>
        </div>

        <div id="progressBarContainer">
            <div id="progressBar">
                <div id="progressTextContainer">
                    <span id="progressText">0%</span>
                </div>
            </div>
        </div>

        <div id="stats-container" class="stats-container">
            <table id="stats-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Video name</th>
                        <th>Number of throws</th>
                        <th>Number of goals</th>
                        <th>Number of misses</th>
                        <th>Accuracy</th>
                        <th>Upload date</th>
                    </tr>
                </thead>
                <tbody id="stats-body">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const fileInput = document.getElementById('file-input');

        function checkFileFormat(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            return extension === 'mp4';
        }

        function triggerFileInput() {
            fileInput.click();

            fileInput.onchange = () => {
                const file = fileInput.files[0];
                if (file) {
                    if (checkFileFormat(file.name)) {
                        uploadFile(file);
                    } else {
                        alert('Please select an MP4 file.');
                    }
                } else {
                    alert('Please select a file to upload.');
                }
            };
        }

        let currentTaskId = null;

        async function uploadFile(file) {
            resetProgress();
            progressBarContainer.style.display = 'block'; // Show the progress bar container

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('videos/upload_video_endpoint/3-point-throws', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    console.log('Test function started successfully');
                    currentTaskId = data.task_id; // Store the current task ID
                    startWebSocket(data.task_id);
                } else {
                    console.error('Test function start failed:', data.error);
                }
            } catch (error) {
                console.error('Error starting test function:', error);
            }
        }

        function resetProgress() {
            progressBar.style.width = '0%';
            progressText.innerText = '0%';
        }

        function startWebSocket(taskId) {
            const socket = new WebSocket(`ws://localhost:8000/videos/ws`);

            socket.onmessage = async function(event) {
                const data = JSON.parse(event.data);
                if (data.progress !== undefined) {
                    progressBar.style.width = data.progress + '%';
                    progressText.innerText = `${data.progress.toFixed(2)}%`;
                }

                if (data.message !== undefined) {
                    socket.close(); // Close the WebSocket when the message is received
                }

            };

            socket.onclose = function(event) {
                console.log('WebSocket is closed now.');
                progressBarContainer.style.display = 'none'; // Hide the progress bar container
                fetchResults(taskId);
            };

            socket.onerror = function(error) {
                console.log('WebSocket Error: ' + error);
                progressBarContainer.style.display = 'none'; // Hide the progress bar container on error
            };
        }

        async function fetchResults(taskId) {
            try {
                const response = await fetch(`videos/get_video_processing_results/${taskId}`);
                const data = await response.json();

                let alertMessage;

                if (data.success) {
                    const score = data.score;
                    const misses = data.misses;
                    const throws = data.throws;
                    alertMessage = `The video was uploaded successfully with results:\nScore: ${score}\nMisses: ${misses}\nThrows: ${throws}\nRefresh the page to upload new one)`;
                } else {
                    alertMessage = `An error occurred during video uploading`;
                }

                alert(alertMessage);
            } catch (error) {
                console.error('Error fetching results:', error);
                alert('An unexpected error occurred while fetching the results.');
            }
        }

        async function getStatistics() {
            try {
                const response = await fetch('/videos/statistics/3-point-throws');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();

                const table = document.getElementById('stats-table');
                const tbody = document.getElementById('stats-body');
                tbody.innerHTML = '';

                data.forEach(video => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="video-link" data-video-path="${video.video_path}">
                            <a href="javascript:void(0);" onclick="openVideoInNewTab('${video.video_path}')">${video.name_video}</a>
                        </td>
                        <td>${video.number_throws}</td>
                        <td>${video.number_goals}</td>
                        <td>${video.number_misses}</td>
                        <td>${video.accuracy}%</td>
                        <td>${new Date(video.date_upload).toLocaleString()}</td>
                        <td>
                            <button onclick="deleteVideo('${video.video_path}', this)" class="delete-button">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                table.style.display = 'table';

            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function deleteVideo(videoPath, button) {
            if (confirm('Are you sure you want to delete this video?')) {
                try {

                    // Make a request to the server to delete the video
                    const response = await fetch(`/videos/delete_video/${videoPath}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Remove the row from the table
                        const row = button.closest('tr');
                        row.remove();
                        alert('Video deleted successfully.');
                    } else {
                        alert('Failed to delete video: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the video.');
                }
            }
        }

        function openVideoInNewTab(videoPath) {
            // Replace backslashes with forward slashes to ensure URL correctness
            // const fixedPath = videoPath.replace(/\\/g, '/');
            const fixedPath = videoPath.replace('result_videos', 'result_videos\\r');
            // const videoURL = `/${fixedPath}`;
            const videoURL = `/${fixedPath}`;
            
            // console.log(videoURL); // For debugging
            window.open(videoURL, '_blank');
        }

        window.addEventListener('beforeunload', async (event) => {
            if (currentTaskId) {
                try {
                    const response = await fetch(`videos/stop_video_processing/${currentTaskId}`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    if (data.success) {
                        console.log('Video processing stopped successfully');
                    } else {
                        console.error('Failed to stop video processing:', data.message);
                    }
                } catch (error) {
                    console.error('Error stopping video processing:', error);
                }
            }
        });
    </script>
    <script src="static/js/header.js"></script>
</body>
</html>
